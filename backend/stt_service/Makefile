# === Variables ===

# ì•„í‚¤í…ì²˜ ì„¤ì •: ê¸°ë³¸ì€ ì‹œìŠ¤í…œ ê°ì§€, ì‚¬ìš©ì ì§€ì • ê°€ëŠ¥
TARGET_ARCH ?= $(shell uname -m)
ifeq ($(TARGET_ARCH),x86_64)
    TARGET_ARCH := x64
endif
ifeq ($(TARGET_ARCH),aarch64)
    TARGET_ARCH := arm64
endif

STT_IMAGE_NAME := stt-service
STT_DOCKERFILE := Dockerfile

UNIT_TEST_IMAGE_NAME := stt-unit-test
UNIT_TEST_DOCKERFILE := Dockerfile.unit_test

EXTERNAL_TEST_IMAGE_NAME := stt-test-external
EXTERNAL_TEST_DOCKERFILE := Dockerfile.test_external

COMPOSE_FILE := docker-compose.yml

# === Targets ===

.PHONY: all build build-stt build-test-client test start stop clean help

all: build

build: build-stt build-external-test
	@echo "âœ… All Docker images built successfully."

build-stt:
	@echo "ğŸš€ Building STT Service image (${STT_IMAGE_NAME}) for arch: ${TARGET_ARCH}..."
	docker build \
		--build-arg TARGET_ARCH=${TARGET_ARCH} \
		-t ${STT_IMAGE_NAME} \
		-f ${STT_DOCKERFILE} .

build-unit-test:
	@echo "ğŸ§ª Building Unit Test image (${STT_IMAGE_NAME}-unit-test)..."
	docker build \
		--build-arg TARGET_ARCH=${TARGET_ARCH} \
		-t ${UNIT_TEST_IMAGE_NAME} \
		-f ${UNIT_TEST_DOCKERFILE} . --no-cache

build-external-test:
	@echo "ğŸ§ª Building External Test Client image (${EXTERNAL_TEST_IMAGE_NAME})..."
	docker build \
		--build-arg TARGET_ARCH=${TARGET_ARCH} \
		-t ${EXTERNAL_TEST_IMAGE_NAME} \
		-f ${EXTERNAL_TEST_DOCKERFILE} . --no-cache

unit-test: build-unit-test
	@echo "ğŸ§ª Running Unit Tests..."
	docker run --rm ${UNIT_TEST_IMAGE_NAME}

external-test: build
	@echo "ğŸ“Š Running integration tests via Docker Compose..."
	TARGET_ARCH=${TARGET_ARCH} docker compose -f ${COMPOSE_FILE} up --build --abort-on-container-exit --exit-code-from stt-service
	@echo "ğŸ“Š Integration tests completed. Stopping services..."

start:
	@echo "ğŸš€ Starting STT service and Mock LLM service in detached mode..."
	TARGET_ARCH=${TARGET_ARCH} docker compose -f ${COMPOSE_FILE} up -d --build stt-service mock-llm
	@echo "âœ… Services started. Use 'make logs' or 'make stop'."

down:
	@echo "ğŸ›‘ Stopping services defined in ${COMPOSE_FILE}..."
	docker compose -f ${COMPOSE_FILE} down
	@echo "âœ… Services stopped."

stop:
	@echo "ğŸ›‘ Stopping services defined in ${COMPOSE_FILE}..."
	docker compose -f ${COMPOSE_FILE} down

clean: stop
	@echo "ğŸ§¹ Cleaning up build artifacts..."
	rm -rf build
	@echo "ğŸ§¹ Cleaning up Docker Compose resources..."
	@echo "âœ… Cleanup complete."

logs:
	@echo "ğŸ“œ Tailing logs for running services..."
	docker compose -f ${COMPOSE_FILE} logs -f --tail=50

help:
	@echo "ğŸ“œ Makefile Help: Available targets:"
	@echo "  all                - Build all images (default target)"
	@echo "  build              - Build STT service image"
	@echo "  build-stt          - Build STT service image"
	@echo "  build-unit-test    - Build Unit Test image"
	@echo "  build-external-test- Build External Test Client image"
	@echo "  unit-test          - Run unit tests in Docker container"
	@echo "  test               - Run integration tests using Docker Compose"
	@echo "  start              - Start STT service and Mock LLM service"
	@echo "  stop               - Stop running services"
	@echo "  clean              - Clean up build artifacts and stopped containers"
	@echo "  logs               - Tail logs for running services"