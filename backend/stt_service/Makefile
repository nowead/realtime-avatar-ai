# Makefile for STT Service Project

# === Variables ===

# Docker ì´ë¯¸ì§€ ì´ë¦„ ë° íƒœê·¸ ì„¤ì •
STT_IMAGE_NAME := stt-service
STT_DOCKERFILE := Dockerfile

TEST_CLIENT_IMAGE_NAME := stt-test-external
TEST_CLIENT_DOCKERFILE := Dockerfile.test_external

# Docker Compose íŒŒì¼ ì´ë¦„
COMPOSE_FILE := docker-compose.yml

# === Targets ===

# .PHONY: ê°€ì§œ íƒ€ê²Ÿ ì„ ì–¸ (íŒŒì¼ ì´ë¦„ê³¼ í˜¼ë™ ë°©ì§€)
.PHONY: all build build-stt build-test-client test start stop clean help

# ê¸°ë³¸ íƒ€ê²Ÿ: ëª¨ë“  ì´ë¯¸ì§€ ë¹Œë“œ
all: build

# ëª¨ë“  Docker ì´ë¯¸ì§€ ë¹Œë“œ
build: build-stt#build-test-client
	@echo "âœ… All Docker images built successfully."

# STT ì„œë¹„ìŠ¤ Docker ì´ë¯¸ì§€ ë¹Œë“œ
build-stt:
	@echo "ğŸš€ Building STT Service image (${STT_IMAGE_NAME})..."
	docker build -t ${STT_IMAGE_NAME} -f ${STT_DOCKERFILE} . --no-cache

build-unit-test:
	@echo "ğŸ§ª Building Unit Test image (${STT_IMAGE_NAME}-unit-test)..."
	docker build -t ${STT_IMAGE_NAME}-unit-test -f ${STT_DOCKERFILE} . --no-cache

# í…ŒìŠ¤íŠ¸ í´ë¼ì´ì–¸íŠ¸ Docker ì´ë¯¸ì§€ ë¹Œë“œ
build-test-client:
	@echo "ğŸ§ª Building External Test Client image (${TEST_CLIENT_IMAGE_NAME})..."
	docker build -t ${TEST_CLIENT_IMAGE_NAME} -f ${TEST_CLIENT_DOCKERFILE} . -no-cache

unit-test:
	@echo "ğŸ§ª Running Unit Tests..."
	# ë¹Œë“œëœ ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì´ë¯¸ì§€ë¥¼ ì‚¬ìš©í•˜ì—¬ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
	docker run --rm ${STT_IMAGE_NAME}-unit-test
	@echo "âœ… Unit tests completed."

# Docker Composeë¥¼ ì‚¬ìš©í•˜ì—¬ í†µí•© í…ŒìŠ¤íŠ¸ ì‹¤í–‰
# --build: í•„ìš”ì‹œ ì´ë¯¸ì§€ ë¹Œë“œ
# --abort-on-container-exit: test-client ì»¨í…Œì´ë„ˆ ì¢…ë£Œ ì‹œ ë‹¤ë¥¸ ì»¨í…Œì´ë„ˆë„ ì¤‘ì§€í•˜ê³  ì¢…ë£Œ
# test-client: ì‹¤í–‰í•  ì„œë¹„ìŠ¤ ì§€ì • (ì˜ì¡´ì„± ì„œë¹„ìŠ¤ëŠ” ìë™ìœ¼ë¡œ ì‹œì‘ë¨)
# ì¢…ë£Œ ì½”ë“œê°€ test-clientì˜ ì¢…ë£Œ ì½”ë“œë¥¼ ë°˜ì˜í•˜ë¯€ë¡œ í…ŒìŠ¤íŠ¸ ì„±ê³µ/ì‹¤íŒ¨ í™•ì¸ ê°€ëŠ¥
test: build # í…ŒìŠ¤íŠ¸ ì „ì— ë¹Œë“œë¥¼ ìˆ˜í–‰í•˜ë„ë¡ ì˜ì¡´ì„± ì¶”ê°€
	@echo "ğŸ“Š Running integration tests via Docker Compose..."
	docker-compose -f ${COMPOSE_FILE} up --build --abort-on-container-exit test-client
	@echo "ğŸ§¹ Cleaning up test containers..."
	# í…ŒìŠ¤íŠ¸ í›„ í•­ìƒ ì»¨í…Œì´ë„ˆ ì •ë¦¬ (ì˜¤ë¥˜ ë°œìƒ ì‹œì—ë„ ì •ë¦¬ë˜ë„ë¡)
	docker-compose -f ${COMPOSE_FILE} down

# stt-serviceì™€ mock-llm ì„œë¹„ìŠ¤ë¥¼ ë°±ê·¸ë¼ìš´ë“œ(-d)ì—ì„œ ì‹œì‘
start:
	@echo "ğŸš€ Starting STT service and Mock LLM service in detached mode..."
	docker-compose -f ${COMPOSE_FILE} up -d --build stt-service mock-llm
	@echo "âœ… Services started. Use 'make logs' or 'make stop'."

# docker-composeë¡œ ì‹¤í–‰ëœ ëª¨ë“  ì„œë¹„ìŠ¤ ì¤‘ì§€ ë° ì œê±°
stop:
	@echo "ğŸ›‘ Stopping services defined in ${COMPOSE_FILE}..."
	docker-compose -f ${COMPOSE_FILE} down

# ë¹Œë“œ ì•„í‹°íŒ©íŠ¸ ë° Docker ë¦¬ì†ŒìŠ¤ ì •ë¦¬
clean: stop # ì„œë¹„ìŠ¤ë¥¼ ë¨¼ì € ì¤‘ì§€
	@echo "ğŸ§¹ Cleaning up build artifacts..."
	# CMake ë¹Œë“œ ë””ë ‰í† ë¦¬ ì‚­ì œ (ì´ë¦„ì´ 'build'ë¼ê³  ê°€ì •)
	rm -rf build
	@echo "ğŸ§¹ Cleaning up Docker Compose resources (stopped containers, networks)..."
	# 'stop' íƒ€ê²Ÿì—ì„œ ì´ë¯¸ downì´ í˜¸ì¶œë˜ì—ˆìŒ
	# í•„ìš”ì‹œ ë³¼ë¥¨ë„ ì‚­ì œ: docker-compose -f ${COMPOSE_FILE} down --volumes
	# í•„ìš”ì‹œ Docker ì´ë¯¸ì§€ ì‚­ì œ (ì£¼ì˜!)
	# docker rmi ${STT_IMAGE_NAME}:${STT_IMAGE_TAG} || true
	# docker rmi ${TEST_CLIENT_IMAGE_NAME}:${TEST_CLIENT_IMAGE_TAG} || true
	@echo "âœ… Cleanup complete."

# ë¡œê·¸ í™•ì¸ (ë°±ê·¸ë¼ìš´ë“œ ì‹¤í–‰ ì¤‘ì¸ ì„œë¹„ìŠ¤ ë¡œê·¸)
logs:
	@echo "ğŸ“œ Tailing logs for running services..."
	docker-compose -f ${COMPOSE_FILE} logs -f --tail=50

# ë„ì›€ë§ ë©”ì‹œì§€ í‘œì‹œ
help:
	@echo "Makefile for STT Service Project"
	@echo ""
	@echo "Available targets:"
	@echo "  make build             Build all necessary Docker images."
	@echo "  make build-stt         Build only the STT service image."
	@echo "  make build-test-client Build only the test client image."
	@echo "  make test              Build images and run integration tests using Docker Compose."
	@echo "  make start             Start STT service and Mock LLM in detached mode."
	@echo "  make stop              Stop and remove services started by 'start' or 'test'."
	@echo "  make clean             Stop services, remove build artifacts and Docker resources."
	@echo "  make logs              Tail logs from running services (started with 'make start')."
	@echo "  make help              Show this help message."
	@echo ""