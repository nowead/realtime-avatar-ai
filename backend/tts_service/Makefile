# --- ë³€ìˆ˜ ì •ì˜ ---
COMPOSE       = docker compose
COMPOSE_FILE ?= docker-compose.yml
SERVICE      ?=

# --- ë¹Œë“œ ---
all: build

# ëª¨ë“  ì„œë¹„ìŠ¤ ë¹Œë“œ
build: build-tts build-test
	@echo "--- âœ… ëª¨ë“  ì„œë¹„ìŠ¤ ë¹Œë“œ ì™„ë£Œ ---"

# tts-serviceë§Œ ë¹Œë“œ
build-tts:
	@echo "--- ğŸ”¨ TTS ì„œë¹„ìŠ¤ ë¹Œë“œ ---"
	$(COMPOSE) -f $(COMPOSE_FILE) build tts-service
	@echo "--- âœ… TTS ë¹Œë“œ ì™„ë£Œ ---"

# test-clientë§Œ ë¹Œë“œ
build-test:
	@echo "--- ğŸ”¨ í…ŒìŠ¤íŠ¸ í´ë¼ì´ì–¸íŠ¸ ë¹Œë“œ ---"
	$(COMPOSE) -f $(COMPOSE_FILE) build --no-cache test-client
	@echo "--- âœ… í…ŒìŠ¤íŠ¸ í´ë¼ì´ì–¸íŠ¸ ë¹Œë“œ ì™„ë£Œ ---"

# --- ì‹¤í–‰/ì¤‘ì§€ ---

up:
	@echo "--- ğŸš€ ì„œë¹„ìŠ¤ ì‹œì‘ ì¤‘ ---"
	$(COMPOSE) -f $(COMPOSE_FILE) up -d --remove-orphans
	@echo "--- âœ… ì„œë¹„ìŠ¤ ì‹œì‘ ì™„ë£Œ ---"

restart:
	@echo "--- ğŸ” ì„œë¹„ìŠ¤ ì¬ì‹œì‘ ---"
	$(COMPOSE) -f $(COMPOSE_FILE) restart $(SERVICE)
	@echo "--- âœ… ì¬ì‹œì‘ ì™„ë£Œ ---"

stop:
	@echo "--- â›” ì„œë¹„ìŠ¤ ì¤‘ì§€ ---"
	$(COMPOSE) -f $(COMPOSE_FILE) stop $(SERVICE)
	@echo "--- âœ… ì¤‘ì§€ ì™„ë£Œ ---"

# --- ì™„ì „ ì‚­ì œ ---

down:
	@echo "--- ğŸ’£ ëª¨ë“  Docker Compose ë¦¬ì†ŒìŠ¤ ì‚­ì œ ì¤‘ ---"
	$(COMPOSE) -f $(COMPOSE_FILE) down --volumes --remove-orphans --rmi all
	docker system prune -af --volumes --filter "label=stage=tts-service" --filter "label=stage=test-client" || true
	@echo "--- ğŸ§¹ ì´ë¯¸ì§€/ë³¼ë¥¨/ìºì‹œ ì •ë¦¬ ì™„ë£Œ ---"

# --- í…ŒìŠ¤íŠ¸ ---

test:
	$(MAKE) up
	$(COMPOSE) run --rm test-client
	$(MAKE) down

# --- ìƒíƒœ í™•ì¸ ---
ps:
	$(COMPOSE) -f $(COMPOSE_FILE) ps

logs:
	$(COMPOSE) -f $(COMPOSE_FILE) logs -f $(SERVICE)

# --- ì „ì²´ ì‹œìŠ¤í…œ ì •ë¦¬ ---
prune:
	@echo "--- ğŸ§¨ ì „ì²´ Docker ì‹œìŠ¤í…œ ì •ë¦¬ ---"
	@read -p "âš ï¸ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ëª¨ë“  Docker ë¦¬ì†ŒìŠ¤ê°€ ì‚­ì œë©ë‹ˆë‹¤. ê³„ì†í• ê¹Œìš”? (y/N) " c; \
	if [ "$$c" = "y" ] || [ "$$c" = "Y" ]; then \
		docker system prune -af --volumes; \
	else \
		echo "â›” ì·¨ì†Œë¨"; \
	fi

.PHONY: all build build-tts build-test up restart stop down test ps logs prune
