# Makefile for tts_service

# === Variables ===

# ì•„í‚¤í…ì²˜ ì„¤ì •: ê¸°ë³¸ì€ ì‹œìŠ¤í…œ ê°ì§€, ì‚¬ìš©ì ì§€ì • ê°€ëŠ¥ (ì˜ˆ: make TARGET_ARCH=x64)
# uname -m ê²°ê³¼ì— ë”°ë¼ x64 ë˜ëŠ” arm64ë¡œ ì„¤ì •
TARGET_ARCH ?= $(shell uname -m)

ifeq ($(TARGET_ARCH),x86_64)
    TARGET_ARCH := x64
else ifeq ($(TARGET_ARCH),aarch64)
    TARGET_ARCH := arm64
else ifeq ($(TARGET_ARCH),arm64)
    TARGET_ARCH := arm64
else
    $(warning "Unsupported architecture: $(TARGET_ARCH). Falling back to x64.")
    TARGET_ARCH := x64
endif

# Docker ì´ë¯¸ì§€ ë° íŒŒì¼ ì´ë¦„ ì„¤ì •
TTS_IMAGE_NAME := tts-service
TTS_DOCKERFILE := Dockerfile  # ë©”ì¸ TTS ì„œë¹„ìŠ¤ Dockerfile

# ìœ ë‹› í…ŒìŠ¤íŠ¸ìš© Dockerfileì€ ë³„ë„ë¡œ ì •ì˜í•˜ì§€ ì•ŠìŒ (ë©”ì¸ Dockerfileì—ì„œ BUILD_TESTING=ONìœ¼ë¡œ ë¹Œë“œ)
# í•„ìš”í•˜ë‹¤ë©´ Dockerfile.unit_test ì™€ ê°™ì´ ë³„ë„ ì •ì˜ ê°€ëŠ¥
UNIT_TEST_IMAGE_NAME := tts-unit-test # ìœ ë‹› í…ŒìŠ¤íŠ¸ìš© Docker ì´ë¯¸ì§€ ì´ë¦„
UNIT_TEST_DOCKERFILE := Dockerfile.unit_test # ìœ ë‹› í…ŒìŠ¤íŠ¸ìš© Dockerfile

# ì™¸ë¶€ í†µí•© í…ŒìŠ¤íŠ¸ìš© ì´ë¯¸ì§€ ë° Dockerfile (Python í…ŒìŠ¤íŠ¸ í™˜ê²½)
EXTERNAL_TEST_IMAGE_NAME := tts-test-external
EXTERNAL_TEST_DOCKERFILE := Dockerfile.external_test

# Docker Compose íŒŒì¼
COMPOSE_FILE := docker-compose.yml

# .env íŒŒì¼ (API í‚¤ ë° ë¦¬ì „ ì •ë³´ í¬í•¨)
ENV_FILE := .env

# === Targets ===

.PHONY: all build build-tts build-external-test unit-test external-test start stop down clean logs help

all: build
	@echo "âœ… Default target 'all' (build) completed."

# ë©”ì¸ ì„œë¹„ìŠ¤ ë° í…ŒìŠ¤íŠ¸ í´ë¼ì´ì–¸íŠ¸ ì´ë¯¸ì§€ ë¹Œë“œ
build: build-tts #build-external-test
	@echo "âœ… All required Docker images built successfully."

# TTS ì„œë¹„ìŠ¤ Docker ì´ë¯¸ì§€ ë¹Œë“œ
build-tts:
	@echo "ğŸš€ Building TTS Service image (${TTS_IMAGE_NAME}) for TARGET_ARCH: ${TARGET_ARCH}..."
	docker build \
		--build-arg TARGET_ARCH=${TARGET_ARCH} \
		-t ${TTS_IMAGE_NAME} \
		-f ${TTS_DOCKERFILE} . --no-cache

build-unit-test:
	@echo "ğŸ§ª Building Unit Test image (${TTS_IMAGE_NAME}-unit-test) for TARGET_ARCH: ${TARGET_ARCH}..."
	docker build \
		--build-arg TARGET_ARCH=${TARGET_ARCH} \
		-t ${UNIT_TEST_IMAGE_NAME} \
		-f ${UNIT_TEST_DOCKERFILE} . --no-cache

# ì™¸ë¶€ í†µí•© í…ŒìŠ¤íŠ¸ìš© Python í´ë¼ì´ì–¸íŠ¸ ì´ë¯¸ì§€ ë¹Œë“œ
build-external-test:
	@echo "ğŸ§ª Building External Test Client image (${EXTERNAL_TEST_IMAGE_NAME}) for TARGET_ARCH: ${TARGET_ARCH}..."
	docker build \
		--build-arg TARGET_ARCH=${TARGET_ARCH} \
		-t ${EXTERNAL_TEST_IMAGE_NAME}:latest \
		-f ${EXTERNAL_TEST_DOCKERFILE} . --no-cache

# C++ ìœ ë‹› í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (Docker ë‚´ë¶€ì—ì„œ ë¹Œë“œ ë° ì‹¤í–‰)
# ì´ ë°©ì‹ì€ Dockerfile ë‚´ì—ì„œ í…ŒìŠ¤íŠ¸ë¥¼ ë¹Œë“œí•˜ê³  ì‹¤í–‰í•˜ëŠ” ë‹¨ê³„ë¥¼ í¬í•¨í•´ì•¼ í•¨.
# ë˜ëŠ”, ë¡œì»¬ì—ì„œ ë¹Œë“œ í›„ ì‹¤í–‰ íŒŒì¼ì„ ì»¨í…Œì´ë„ˆì— ë³µì‚¬í•˜ì—¬ ì‹¤í–‰.
# ì—¬ê¸°ì„œëŠ” Dockerfile ë‚´ì—ì„œ BUILD_TESTING=ONìœ¼ë¡œ ë¹Œë“œí•˜ê³ , í•´ë‹¹ ì»¨í…Œì´ë„ˆë¥¼ ì‹¤í–‰í•˜ì—¬ í…ŒìŠ¤íŠ¸.
unit-test: build-unit-test
	@echo "ğŸ§ª Running Unit Tests inside the container..."
	# unit_tests ì‹¤í–‰ íŒŒì¼ì´ /app/build/unit_tests ì— ìƒì„±ëœë‹¤ê³  ê°€ì • (CMakeLists.txt ì„¤ì •ì— ë”°ë¼ ë‹¤ë¦„)
	docker run --rm ${UNIT_TEST_IMAGE_NAME}
	@echo "ğŸ§ª Unit Tests completed. Check the output above for results."

# ì™¸ë¶€ í†µí•© í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (Docker Compose ì‚¬ìš©)
# test-client-tts ì„œë¹„ìŠ¤ê°€ í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰í•˜ê³  ê²°ê³¼ë¥¼ ë°˜í™˜
external-test: build-tts build-external-test
	@echo "ğŸ“Š Running integration tests via Docker Compose (TARGET_ARCH: ${TARGET_ARCH})..."
	@echo "Ensure your .env file is configured with AZURE_SPEECH_KEY and AZURE_SPEECH_REGION."
	# TARGET_ARCHë¥¼ docker-compose up ëª…ë ¹ì–´ì— í™˜ê²½ ë³€ìˆ˜ë¡œ ì „ë‹¬
	TARGET_ARCH=${TARGET_ARCH} docker compose -f ${COMPOSE_FILE} --env-file ${ENV_FILE} up \
		--build \
		--abort-on-container-exit \
		--exit-code-from test-client-tts
	@echo "ğŸ“Š Integration tests completed. Use 'make down' or 'make logs' for details."

# ë³„ì¹­: test -> external-test (stt_service Makefile ì°¸ê³ )
test: external-test

# ì„œë¹„ìŠ¤ ì‹œì‘ (detached mode)
start:
	@echo "ğŸš€ Starting TTS service and Mock AvatarSync service in detached mode (TARGET_ARCH: ${TARGET_ARCH})..."
	TARGET_ARCH=${TARGET_ARCH} docker compose -f ${COMPOSE_FILE} --env-file ${ENV_FILE} up -d --build tts-service mock-avatar-sync
	@echo "âœ… Services started. Use 'make logs' or 'make stop'."

# ì„œë¹„ìŠ¤ ì¤‘ì§€ ë° ì»¨í…Œì´ë„ˆ ì œê±°
down:
	@echo "ğŸ›‘ Stopping and removing services defined in ${COMPOSE_FILE}..."
	TARGET_ARCH=${TARGET_ARCH} docker compose -f ${COMPOSE_FILE} --env-file ${ENV_FILE} down -v --remove-orphans
	@echo "âœ… Services stopped and removed."

# ì„œë¹„ìŠ¤ ì¤‘ì§€ (downì˜ ë³„ì¹­)
stop: down

# ë¹Œë“œ ì•„í‹°íŒ©íŠ¸ ë° Docker ë¦¬ì†ŒìŠ¤ ì •ë¦¬
clean:
	@echo "ğŸ§¹ Stopping and removing services (if any)..."
	-TARGET_ARCH=${TARGET_ARCH} docker compose -f ${COMPOSE_FILE} --env-file ${ENV_FILE} down -v --remove-orphans
	@echo "ğŸ§¹ Cleaning up local build artifacts (./build, ./build_unit_test, ./test_results)..."
	rm -rf build
	rm -rf ${UNIT_TEST_BUILD_DIR}
	rm -rf test_results
	@echo "ğŸ§¹ Removing Docker images (tts-service, tts-test-external)..."
	-docker rmi ${TTS_IMAGE_NAME}:latest ${TTS_IMAGE_NAME}:unit-test ${EXTERNAL_TEST_IMAGE_NAME}:latest
	@echo "ğŸ§¹ Pruning unused Docker data (optional, be careful)..."
	# -docker system prune -af # ì£¼ì„ ì²˜ë¦¬: ì‚¬ìš© ì‹œ ì£¼ì˜
	@echo "âœ… Cleanup attempt complete."

# ì‹¤í–‰ ì¤‘ì¸ ì„œë¹„ìŠ¤ ë¡œê·¸ í™•ì¸
logs:
	@echo "ğŸ“œ Tailing logs for services defined in ${COMPOSE_FILE}..."
	TARGET_ARCH=${TARGET_ARCH} docker compose -f ${COMPOSE_FILE} --env-file ${ENV_FILE} logs -f --tail=100

# ë„ì›€ë§ ë©”ì‹œì§€
help:
	@echo ""
	@echo "Makefile for TTS Service"
	@echo "--------------------------"
	@echo "Usage: make [target]"
	@echo ""
	@echo "Variables:"
	@echo "  TARGET_ARCH      (Optional) Target architecture (e.g., x64, arm64). Default: auto-detected."
	@echo "                     Example: make TARGET_ARCH=arm64 build"
	@echo "  ENV_FILE         (Optional) Path to .env file. Default: ./.env"
	@echo ""
	@echo "Main Targets:"
	@echo "  all                Build all required Docker images (default)."
	@echo "  build              Alias for 'all'."
	@echo "  build-tts          Build the main TTS service Docker image."
	@echo "  build-external-test Build the Python external test client image."
	@echo "  unit-test          Build (if needed) and run C++ unit tests in a Docker container."
	@echo "  external-test      Run Python integration tests using Docker Compose."
	@echo "  test               Alias for 'external-test'."
	@echo ""
	@echo "Service Management (Docker Compose):"
	@echo "  start              Start TTS service and mock-avatar-sync in detached mode."
	@echo "  stop               Stop and remove running services (alias for 'down')."
	@echo "  down               Stop and remove services, networks, and volumes."
	@echo "  logs               Tail logs from running services."
	@echo ""
	@echo "Cleanup:"
	@echo "  clean              Stop services, remove build artifacts, and Docker images."
	@echo ""
	@echo "Other:"
	@echo "  help               Show this help message."
	@echo ""