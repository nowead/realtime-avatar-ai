# --- λ³€μ μ •μ ---
MAKE			?= make # Make λ…λ Ήμ–΄ μμ²΄λ¥Ό μ°Έμ΅°ν•  λ• μ‚¬μ© (μ¬κ·€μ  νΈμ¶ λ“±)
COMPOSE			= docker compose
COMPOSE_FILE	?= docker-compose.yml
service			?=

# --- ν…μ¤νΈ κ΄€λ ¨ λ³€μ ---
# ν…μ¤νΈ ν΄λΌμ΄μ–ΈνΈκ°€ μƒμ„±ν•λ” μ¤λ””μ¤ νμΌ κ²½λ΅ (νΈμ¤νΈ κΈ°μ¤€)
TEST_OUTPUT_FILE = ./tests/output_stream.pcm
# ffplay μ¬μƒ λ…λ Ήμ–΄ λ° μµμ…
# -autoexit: μ¬μƒ μ™„λ£ μ‹ μλ™ μΆ…λ£
# -nodisp: λΉ„λ””μ¤ λ””μ¤ν”λ μ΄ μ°½ ν‘μ‹ μ•ν•¨ (μ¤λ””μ¤λ§ μ¬μƒ μ‹)
# -f s16le: ν¬λ§· (signed 16-bit little-endian)
# -ar 16000: μƒν”λ§ μ†λ„ (16kHz)
# -ac 1: μ±„λ„ (λ¨λ…Έ)
PLAY_COMMAND = ffplay -autoexit -nodisp -f s16le -ar 16000 -ac 1

# --- λΉλ“ ---
all: build

# λ¨λ“  μ„λΉ„μ¤ λΉλ“
build: build-tts build-test
	@echo "--- β… λ¨λ“  μ„λΉ„μ¤ λΉλ“ μ™„λ£ ---"

# tts-serviceλ§ λΉλ“
build-tts:
	@echo "--- π”¨ TTS μ„λΉ„μ¤ λΉλ“ ---"
	$(COMPOSE) -f $(COMPOSE_FILE) build tts-service
	@echo "--- β… TTS λΉλ“ μ™„λ£ ---"

# test-clientλ§ λΉλ“
build-test:
	@echo "--- π”¨ ν…μ¤νΈ ν΄λΌμ΄μ–ΈνΈ λΉλ“ ---"
	$(COMPOSE) -f $(COMPOSE_FILE) build --no-cache test-client
	@echo "--- β… ν…μ¤νΈ ν΄λΌμ΄μ–ΈνΈ λΉλ“ μ™„λ£ ---"

# --- μ‹¤ν–‰/μ¤‘μ§€ ---

up:
	@echo "--- π€ μ„λΉ„μ¤ μ‹μ‘ μ¤‘ ---"
	$(COMPOSE) -f $(COMPOSE_FILE) up -d --remove-orphans
	@echo "--- β… μ„λΉ„μ¤ μ‹μ‘ μ™„λ£ ---"

restart:
	@echo "--- π” μ„λΉ„μ¤ μ¬μ‹μ‘ ---"
	$(COMPOSE) -f $(COMPOSE_FILE) restart $(SERVICE)
	@echo "--- β… μ¬μ‹μ‘ μ™„λ£ ---"

stop:
	@echo "--- β›” μ„λΉ„μ¤ μ¤‘μ§€ ---"
	$(COMPOSE) -f $(COMPOSE_FILE) stop $(SERVICE)
	@echo "--- β… μ¤‘μ§€ μ™„λ£ ---"

# --- μ™„μ „ μ‚­μ  ---

down:
	@echo "--- π’£ λ¨λ“  Docker Compose λ¦¬μ†μ¤ μ‚­μ  μ¤‘ ---"
	$(COMPOSE) -f $(COMPOSE_FILE) down --volumes --remove-orphans --rmi all
	docker system prune -af --volumes --filter "label=stage=tts-service" --filter "label=stage=test-client" || true
	@echo "--- π§Ή μ»¨ν…μ΄λ„/λ„¤νΈμ›ν¬/λ³Όλ¥¨ μ •λ¦¬ μ™„λ£ ---"

# --- ν…μ¤νΈ λ° μ¬μƒ ---

test: up ## ν…μ¤νΈ μ‹¤ν–‰ ν›„ κ²°κ³Ό μ¤λ””μ¤ μλ™ μ¬μƒ
	@echo "--- β–¶οΈ ν…μ¤νΈ ν΄λΌμ΄μ–ΈνΈ μ‹¤ν–‰ ---"
	# ν…μ¤νΈ ν΄λΌμ΄μ–ΈνΈ μ‹¤ν–‰ (μ΄ κ³Όμ •μ—μ„ TEST_OUTPUT_FILE μƒμ„± κ°€μ •)
	$(COMPOSE) -f $(COMPOSE_FILE) run --rm test-client
	@echo "--- β… ν…μ¤νΈ ν΄λΌμ΄μ–ΈνΈ μ™„λ£ ---"
	@# --- μƒμ„±λ μ¤λ””μ¤ νμΌ μ¬μƒ μ‹μ‘ ---
	@if [ -f "$(TEST_OUTPUT_FILE)" ]; then \
		echo "--- π” ν…μ¤νΈ μ¤λ””μ¤ μ¬μƒ μ‹λ„: $(TEST_OUTPUT_FILE) ---"; \
		if command -v $(firstword $(PLAY_COMMAND)) > /dev/null 2>&1; then \
			$(PLAY_COMMAND) $(TEST_OUTPUT_FILE); \
			echo "--- β… μ¤λ””μ¤ μ¬μƒ μ™„λ£ ---"; \
		else \
			echo ""; \
			echo "!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!"; \
			echo "! μ¬μƒ μ¤λ¥: νΈμ¤νΈ λ¨Έμ‹ μ— 'ffplay' λ…λ Ήμ–΄λ¥Ό μ°Ύμ„ μ μ—†μµλ‹λ‹¤.         !"; \
			echo "! 'sudo apt install ffmpeg' λλ” ν•΄λ‹Ή λ°°ν¬ν λ…λ Ήμ–΄λ΅ μ„¤μΉν•΄μ£Όμ„Έμ”. !"; \
			echo "! μλ™ μ¬μƒ: $(PLAY_COMMAND) $(TEST_OUTPUT_FILE)             !"; \
			echo "!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!"; \
			echo ""; \
		fi; \
	else \
		echo ""; \
		echo "!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!"; \
		echo "! μ¬μƒ μ¤λ¥: ν…μ¤νΈ μ¤λ””μ¤ νμΌ '$(TEST_OUTPUT_FILE)'μ„ μ°Ύμ„ μ μ—†μµλ‹λ‹¤. !"; \
		echo "! test_tts_service.cpp μ—μ„ νμΌ μ €μ¥ κ²½λ΅λ¥Ό ν™•μΈν•μ„Έμ”.            !"; \
		echo "!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!"; \
		echo ""; \
	fi

# --- μƒνƒ ν™•μΈ ---
ps:
	$(COMPOSE) -f $(COMPOSE_FILE) ps

logs:
	$(COMPOSE) -f $(COMPOSE_FILE) logs -f $(SERVICE)

# --- μ „μ²΄ μ‹μ¤ν… μ •λ¦¬ ---
prune:
	@echo "--- π§¨ μ „μ²΄ Docker μ‹μ¤ν… μ •λ¦¬ ---"
	@read -p "β οΈ μ‚¬μ©ν•μ§€ μ•λ” λ¨λ“  Docker λ¦¬μ†μ¤(λ„¤νΈμ›ν¬, λΉλ“μΊμ‹ λ“±)κ°€ μ‚­μ λ©λ‹λ‹¤. κ³„μ†ν• κΉμ”? (y/N) " c; \
	if [ "$$c" = "y" ] || [ "$$c" = "Y" ]; then \
		docker system prune -af --volumes; \
		echo "--- β… μ „μ²΄ Docker μ‹μ¤ν… μ •λ¦¬ μ™„λ£ ---"; \
	else \
		echo "β›” μ·¨μ†λ¨"; \
	fi

clean: down
	rm -rf $(TEST_OUTPUT_FILE)
	@echo "--- π§Ή ν…μ¤νΈ μ¤λ””μ¤ νμΌ μ‚­μ  μ™„λ£ ---"

.PHONY: all build build-tts build-test up restart stop down test ps logs prune