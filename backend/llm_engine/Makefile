# llm_engine/Makefile

# === Variables ===

# ì•„í‚¤í…ì²˜ ì„¤ì •: ê¸°ë³¸ì€ ì‹œìŠ¤í…œ ê°ì§€, ì‚¬ìš©ì ì§€ì • ê°€ëŠ¥
TARGET_ARCH ?= $(shell uname -m)
ifeq ($(TARGET_ARCH),x86_64)
    TARGET_ARCH := amd64 # Docker Hub ë° ì¼ë°˜ì ì¸ í‘œê¸°ë²•ì— ë§ê²Œ ë³€ê²½ (x64 ëŒ€ì‹  amd64)
endif
ifeq ($(TARGET_ARCH),aarch64)
    TARGET_ARCH := arm64
endif

# --- llm_engine ì„œë¹„ìŠ¤ ì´ë¦„ ë° íŒŒì¼ ê²½ë¡œ ---
LLM_IMAGE_NAME := llm-engine-service # docker-compose.ymlì˜ ì„œë¹„ìŠ¤ ì´ë¦„ê³¼ ìœ ì‚¬í•˜ê²Œ
LLM_DOCKERFILE := Dockerfile

UNIT_TEST_IMAGE_NAME := llm-unit-test
UNIT_TEST_DOCKERFILE := Dockerfile.unit_test

EXTERNAL_TEST_IMAGE_NAME := llm-test-external # Mock TTS ë° Test Client ë¹Œë“œìš© ì´ë¯¸ì§€
EXTERNAL_TEST_DOCKERFILE := Dockerfile.test_external

COMPOSE_FILE := docker-compose.yml

# === Targets ===

.PHONY: all build build-llm build-unit-test build-external-test unit-test external-test start stop clean logs help

all: build
	@echo "âœ… Default target 'all' executed (equivalent to 'build')."

# ë©”ì¸ ì„œë¹„ìŠ¤ì™€ ì™¸ë¶€ í…ŒìŠ¤íŠ¸ ì´ë¯¸ì§€ë¥¼ ë¹Œë“œí•©ë‹ˆë‹¤.
build: build-llm build-external-test
	@echo "âœ… LLM Engine and External Test Docker images built successfully."

# llm-engine ë©”ì¸ ì„œë¹„ìŠ¤ ì´ë¯¸ì§€ë¥¼ ë¹Œë“œí•©ë‹ˆë‹¤.
build-llm:
	@echo "ğŸš€ Building LLM Engine Service image (${LLM_IMAGE_NAME}) for arch: ${TARGET_ARCH}..."
	docker build \
		--build-arg TARGET_ARCH=${TARGET_ARCH} \
		-t ${LLM_IMAGE_NAME} \
		-f ${LLM_DOCKERFILE} .

# C++ ìœ ë‹› í…ŒìŠ¤íŠ¸ ì´ë¯¸ì§€ë¥¼ ë¹Œë“œí•©ë‹ˆë‹¤.
build-unit-test:
	@echo "ğŸ§ª Building Unit Test image (${UNIT_TEST_IMAGE_NAME})..."
	docker build \
		--build-arg TARGET_ARCH=${TARGET_ARCH} \
		-t ${UNIT_TEST_IMAGE_NAME} \
		-f ${UNIT_TEST_DOCKERFILE} . --no-cache

# Python ì™¸ë¶€ í†µí•© í…ŒìŠ¤íŠ¸ ë° Mock TTS ì„œë²„ ì´ë¯¸ì§€ë¥¼ ë¹Œë“œí•©ë‹ˆë‹¤.
build-external-test:
	@echo "ğŸ Building External Test (Python Env) image (${EXTERNAL_TEST_IMAGE_NAME})..."
	# Python ì´ë¯¸ì§€ëŠ” ì•„í‚¤í…ì²˜ ì¸ìê°€ í•„ìˆ˜ëŠ” ì•„ë‹ ìˆ˜ ìˆìŒ
	docker build \
		--build-arg TARGET_ARCH=${TARGET_ARCH} \
		-t ${EXTERNAL_TEST_IMAGE_NAME} \
		-f ${EXTERNAL_TEST_DOCKERFILE} . --no-cache

# ìœ ë‹› í…ŒìŠ¤íŠ¸ë¥¼ ë¹Œë“œí•˜ê³  ì‹¤í–‰í•©ë‹ˆë‹¤.
unit-test: build-unit-test
	@echo "ğŸ§ª Running Unit Tests in Docker container (${UNIT_TEST_IMAGE_NAME})..."
	# Dockerfile.unit_test ë‚´ì—ì„œ í…ŒìŠ¤íŠ¸ê°€ ì‹¤í–‰ë˜ë„ë¡ ì„¤ì •ë¨
	docker run --rm ${UNIT_TEST_IMAGE_NAME}
	@echo "âœ… Unit tests finished."

# ì™¸ë¶€ í†µí•© í…ŒìŠ¤íŠ¸ë¥¼ ë¹Œë“œí•˜ê³  ì‹¤í–‰í•©ë‹ˆë‹¤. (docker-compose ì‚¬ìš©)
external-test: build # ë©”ì¸ ë° ì™¸ë¶€ í…ŒìŠ¤íŠ¸ ì´ë¯¸ì§€ê°€ í•„ìš”
	@echo "ğŸ“Š Running integration tests via Docker Compose..."
	# docker-compose.ymlì— ì •ì˜ëœ ì„œë¹„ìŠ¤ë¥¼ ë¹Œë“œí•˜ê³  ì‹¤í–‰í•©ë‹ˆë‹¤.
	# --abort-on-container-exit: ì»¨í…Œì´ë„ˆ í•˜ë‚˜ë¼ë„ ì¢…ë£Œë˜ë©´ ëª¨ë‘ ì¤‘ì§€
	# --exit-code-from test-client: test-client ì»¨í…Œì´ë„ˆì˜ ì¢…ë£Œ ì½”ë“œë¥¼ ë°˜í™˜ (í…ŒìŠ¤íŠ¸ ê²°ê³¼)
	TARGET_ARCH=${TARGET_ARCH} docker compose -f ${COMPOSE_FILE} up --build --abort-on-container-exit --exit-code-from test-client
	@echo "ğŸ“Š Integration tests completed. Stopping services..."
	# í…ŒìŠ¤íŠ¸ í›„ ìë™ìœ¼ë¡œ ì„œë¹„ìŠ¤ ì¤‘ì§€ ë° ì œê±° (down)
	# make stop # ëª…ì‹œì ìœ¼ë¡œ stop/down í˜¸ì¶œ í•„ìš” ì—†ì´ upì´ ì¢…ë£Œë˜ë©´ ë¨

# ë°±ê·¸ë¼ìš´ë“œì—ì„œ llm-engineê³¼ mock-tts ì„œë¹„ìŠ¤ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.
start: build # ì´ë¯¸ì§€ê°€ í•„ìš”í•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ build ì˜ì¡´ì„± ì¶”ê°€
	@echo "ğŸš€ Starting LLM service and Mock TTS service in detached mode..."
	TARGET_ARCH=${TARGET_ARCH} docker compose -f ${COMPOSE_FILE} up -d --build llm-engine mock-tts
	@echo "âœ… Services started. Use 'make logs' or 'make stop'."

# docker-composeë¡œ ì‹¤í–‰ ì¤‘ì¸ ì„œë¹„ìŠ¤ë¥¼ ì¤‘ì§€í•˜ê³  ì»¨í…Œì´ë„ˆë¥¼ ì œê±°í•©ë‹ˆë‹¤.
down: stop

# docker-composeë¡œ ì‹¤í–‰ ì¤‘ì¸ ì„œë¹„ìŠ¤ë¥¼ ì¤‘ì§€í•˜ê³  ì»¨í…Œì´ë„ˆë¥¼ ì œê±°í•©ë‹ˆë‹¤.
stop:
	@echo "ğŸ›‘ Stopping services defined in ${COMPOSE_FILE}..."
	docker compose -f ${COMPOSE_FILE} down --remove-orphans
	@echo "âœ… Services stopped and containers removed."

# ë¹Œë“œ ì•„í‹°íŒ©íŠ¸ ë° ì¤‘ì§€ëœ ì»¨í…Œì´ë„ˆ/ë„¤íŠ¸ì›Œí¬ ë“±ì„ ì •ë¦¬í•©ë‹ˆë‹¤.
clean: stop
	@echo "ğŸ§¹ Cleaning up C++ build artifacts..."
	rm -rf build # CMake ë¹Œë“œ ë””ë ‰í† ë¦¬ ì‚­ì œ
	@echo "ğŸ§¹ Cleaning up Docker Compose resources (volumes, networks - if any unused)..."
	# docker system prune -a # ì£¼ì˜: ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ëª¨ë“  ë„ì»¤ ë¦¬ì†ŒìŠ¤ ì‚­ì œ!
	@echo "âœ… Cleanup potentially complete (manual pruning might be needed)."

# ì‹¤í–‰ ì¤‘ì¸ ì„œë¹„ìŠ¤ì˜ ë¡œê·¸ë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ í™•ì¸í•©ë‹ˆë‹¤.
logs:
	@echo "ğŸ“œ Tailing logs for running services..."
	docker compose -f ${COMPOSE_FILE} logs -f --tail=50

# ì‚¬ìš© ê°€ëŠ¥í•œ Makefile íƒ€ê²Ÿ ëª©ë¡ì„ ë³´ì—¬ì¤ë‹ˆë‹¤.
help:
	@echo "ğŸ“œ Makefile Help: Available targets for llm_engine:"
	@echo "  all                  - Build all necessary images (llm-engine, external-test) (default target)"
	@echo "  build                - Build llm-engine and external-test images"
	@echo "  build-llm            - Build the main LLM Engine service image"
	@echo "  build-unit-test      - Build the C++ Unit Test image"
	@echo "  build-external-test  - Build the Python External Test environment image"
	@echo "  unit-test            - Build and run C++ unit tests in Docker"
	@echo "  external-test        - Build images and run Python integration tests using Docker Compose"
	@echo "  start                - Start llm-engine and mock-tts services in detached mode"
	@echo "  stop                 - Stop and remove running services defined in docker-compose.yml"
	@echo "  down                 - Alias for stop"
	@echo "  clean                - Run 'stop' and remove local build directory"
	@echo "  logs                 - Tail logs for running services"
	@echo "  help                 - Show this help message"