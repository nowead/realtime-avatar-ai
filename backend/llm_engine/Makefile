# llm_engine/Makefile

# === Variables ===

# ì•„í‚¤í…ì²˜ ì„¤ì •: ê¸°ë³¸ì€ ì‹œìŠ¤í…œ ê°ì§€, ì‚¬ìš©ì ì§€ì • ê°€ëŠ¥
TARGET_ARCH ?= $(shell uname -m)
ifeq ($(TARGET_ARCH),x86_64)
	TARGET_ARCH := amd64 # Docker Hub ë° ì¼ë°˜ì ì¸ í‘œê¸°ë²•ì— ë§ê²Œ ë³€ê²½ (x64 ëŒ€ì‹  amd64)
endif
ifeq ($(TARGET_ARCH),aarch64)
	TARGET_ARCH := arm64
endif

# --- llm_engine ì„œë¹„ìŠ¤ ì´ë¦„ ë° íŒŒì¼ ê²½ë¡œ ---
LLM_IMAGE_TAG := llm-engine-service
LLM_DOCKERFILE := Dockerfile

UNIT_TEST_IMAGE_TAG := llm-unit-test
UNIT_TEST_DOCKERFILE := Dockerfile.unit_test # C++ ìœ ë‹› í…ŒìŠ¤íŠ¸ìš© Dockerfile

# Python í™˜ê²½ (Mock TTS, Test Client) ìš© ì´ë¯¸ì§€ íƒœê·¸ ë° Dockerfile ì´ë¦„
EXTERNAL_TEST_IMAGE_TAG := llm-python-env
EXTERNAL_TEST_DOCKERFILE := Dockerfile.external_test # ì´ì „ ì œì•ˆì—ì„œ ì‚¬ìš©í•œ ì´ë¦„

COMPOSE_FILE := docker-compose.yml
ENV_FILE := .env

# === Targets ===

.PHONY: all build build-llm build-unit-test build-external-test unit-test external-test start stop down clean logs help

all: build
	@echo "âœ… Default target 'all' executed (equivalent to 'build')."

# ë©”ì¸ ì„œë¹„ìŠ¤ì™€ ì™¸ë¶€ í…ŒìŠ¤íŠ¸ ì´ë¯¸ì§€ë¥¼ ë¹Œë“œí•©ë‹ˆë‹¤.
build: build-llm build-external-test
	@echo "âœ… LLM Engine and External Test Docker images built successfully."

# llm-engine ë©”ì¸ ì„œë¹„ìŠ¤ ì´ë¯¸ì§€ë¥¼ ë¹Œë“œí•©ë‹ˆë‹¤.
build-llm:
	@echo "ğŸš€ Building LLM Engine Service image (${LLM_IMAGE_TAG}) for arch: ${TARGET_ARCH}..."
	docker build \
		--build-arg TARGET_ARCH=${TARGET_ARCH} \
		-t ${LLM_IMAGE_TAG} \
		-f ${LLM_DOCKERFILE} . --no-cache

# C++ ìœ ë‹› í…ŒìŠ¤íŠ¸ ì´ë¯¸ì§€ë¥¼ ë¹Œë“œí•©ë‹ˆë‹¤.
build-unit-test:
	@echo "ğŸ§ª Building Unit Test image (${UNIT_TEST_IMAGE_TAG})..."
	docker build \
		-t ${UNIT_TEST_IMAGE_TAG} \
		-f ${UNIT_TEST_DOCKERFILE} . # --no-cache # í•„ìš”ì‹œ í™œì„±í™” (ë¹Œë“œ ì‹œê°„ ì¦ê°€)

# Python ì™¸ë¶€ í†µí•© í…ŒìŠ¤íŠ¸ ë° Mock TTS ì„œë²„ ì´ë¯¸ì§€ë¥¼ ë¹Œë“œí•©ë‹ˆë‹¤.
build-external-test:
	@echo "ğŸ Building External Test (Python Env) image (${EXTERNAL_TEST_IMAGE_TAG})..."
	docker build \
		--build-arg TARGET_ARCH=${TARGET_ARCH} \
		-t ${EXTERNAL_TEST_IMAGE_TAG} \
		-f ${EXTERNAL_TEST_DOCKERFILE} . --no-cache

# ìœ ë‹› í…ŒìŠ¤íŠ¸ë¥¼ ë¹Œë“œí•˜ê³  ì‹¤í–‰í•©ë‹ˆë‹¤.
unit-test: build-unit-test
	@echo "ğŸ§ª Running Unit Tests in Docker container (${UNIT_TEST_IMAGE_TAG})..."
	# Dockerfile.unit_test ë‚´ì—ì„œ í…ŒìŠ¤íŠ¸ê°€ ì‹¤í–‰ë˜ë„ë¡ ì„¤ì •ë¨ (ì˜ˆ: CMD ["./run_tests"])
	docker run --rm ${UNIT_TEST_IMAGE_TAG}
	@echo "âœ… Unit tests finished."

# ì™¸ë¶€ í†µí•© í…ŒìŠ¤íŠ¸ë¥¼ ë¹Œë“œí•˜ê³  ì‹¤í–‰í•©ë‹ˆë‹¤. (docker-compose ì‚¬ìš©)
external-test: build # ë©”ì¸ ë° ì™¸ë¶€ í…ŒìŠ¤íŠ¸ ì´ë¯¸ì§€ê°€ í•„ìš”
	@echo "ğŸ“Š Running integration tests via Docker Compose..."
	# docker-compose.ymlì— ì •ì˜ëœ ì„œë¹„ìŠ¤ë¥¼ ë¹Œë“œí•˜ê³  ì‹¤í–‰í•©ë‹ˆë‹¤.
	# --abort-on-container-exit: ì»¨í…Œì´ë„ˆ í•˜ë‚˜ë¼ë„ ì¢…ë£Œë˜ë©´ ëª¨ë‘ ì¤‘ì§€
	# --exit-code-from test-client: test-client ì»¨í…Œì´ë„ˆì˜ ì¢…ë£Œ ì½”ë“œë¥¼ ë°˜í™˜ (í…ŒìŠ¤íŠ¸ ê²°ê³¼)
	TARGET_ARCH=${TARGET_ARCH} docker compose -f ${COMPOSE_FILE} --env-file ${ENV_FILE} up \
		--build \
		--abort-on-container-exit \
		--exit-code-from test-client
	@echo "ğŸ“Š Integration tests completed. Test client exited. Services will be stopped by 'up' command's nature with --abort-on-container-exit."

# ë°±ê·¸ë¼ìš´ë“œì—ì„œ llm-engineê³¼ mock-tts ì„œë¹„ìŠ¤ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.
start: build # ì´ë¯¸ì§€ê°€ í•„ìš”í•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ build ì˜ì¡´ì„± ì¶”ê°€
	@echo "ğŸš€ Starting LLM service and Mock TTS service in detached mode..."
	@[ -f $(ENV_FILE) ] || (echo "âš ï¸ Warning: $(ENV_FILE) not found. Using default environment variables." && touch $(ENV_FILE))
	TARGET_ARCH=${TARGET_ARCH} docker compose -f ${COMPOSE_FILE} --env-file ${ENV_FILE} up -d --build llm-engine mock-tts
	@echo "âœ… Services started. Use 'make logs' or 'make stop'."

# docker-composeë¡œ ì‹¤í–‰ ì¤‘ì¸ ì„œë¹„ìŠ¤ë¥¼ ì¤‘ì§€í•˜ê³  ì»¨í…Œì´ë„ˆë¥¼ ì œê±°í•©ë‹ˆë‹¤.
down: stop

# docker-composeë¡œ ì‹¤í–‰ ì¤‘ì¸ ì„œë¹„ìŠ¤ë¥¼ ì¤‘ì§€í•˜ê³  ì»¨í…Œì´ë„ˆë¥¼ ì œê±°í•©ë‹ˆë‹¤.
stop:
	@echo "ğŸ›‘ Stopping services defined in ${COMPOSE_FILE}..."
	@[ -f $(ENV_FILE) ] || (echo "âš ï¸ Warning: $(ENV_FILE) not found. Using default environment variables." && touch $(ENV_FILE))
	TARGET_ARCH=${TARGET_ARCH} docker compose -f ${COMPOSE_FILE} --env-file ${ENV_FILE} down --remove-orphans
	@echo "âœ… Services stopped and containers removed."

# ë¹Œë“œ ì•„í‹°íŒ©íŠ¸ ë° ì¤‘ì§€ëœ ì»¨í…Œì´ë„ˆ/ë„¤íŠ¸ì›Œí¬ ë“±ì„ ì •ë¦¬í•©ë‹ˆë‹¤.
clean: stop
	@echo "ğŸ§¹ Cleaning up C++ build artifacts..."
	rm -rf ./test_results || true
	@echo "ğŸ§¹ Cleaning up Docker images built by this Makefile..."
	docker rmi ${LLM_IMAGE_TAG} || true
	docker rmi ${EXTERNAL_TEST_IMAGE_TAG} || true
	docker rmi ${UNIT_TEST_IMAGE_TAG} || true
	@echo "ğŸ§¹ Cleaning up Docker Compose resources (volumes, networks - if any unused)..."
	docker system prune -a
	@echo "âœ… Cleanup potentially complete (manual pruning might be needed for other Docker resources)."

# ì‹¤í–‰ ì¤‘ì¸ ì„œë¹„ìŠ¤ì˜ ë¡œê·¸ë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ í™•ì¸í•©ë‹ˆë‹¤.
logs:
	@echo "ğŸ“œ Tailing logs for running services..."
	@[ -f $(ENV_FILE) ] || (echo "âš ï¸ Warning: $(ENV_FILE) not found. Using default environment variables." && touch $(ENV_FILE))
	TARGET_ARCH=${TARGET_ARCH} docker compose -f ${COMPOSE_FILE} --env-file ${ENV_FILE} logs -f --tail=50

# ì‚¬ìš© ê°€ëŠ¥í•œ Makefile íƒ€ê²Ÿ ëª©ë¡ì„ ë³´ì—¬ì¤ë‹ˆë‹¤.
help:
	@echo "ğŸ“œ Makefile Help: Available targets for llm_engine:"
	@echo "  all                  - Build all necessary images (llm-engine, external-test) (default target)"
	@echo "  build                - Build llm-engine and external-test images"
	@echo "  build-llm            - Build the main LLM Engine service image (${LLM_IMAGE_TAG})"
	@echo "  build-unit-test      - Build the C++ Unit Test image (${UNIT_TEST_IMAGE_TAG})"
	@echo "  build-external-test  - Build the Python External Test environment image (${EXTERNAL_TEST_IMAGE_TAG})"
	@echo "  unit-test            - Build and run C++ unit tests in Docker"
	@echo "  external-test        - Build images and run Python integration tests using Docker Compose (needs .env file)"
	@echo "  start                - Start llm-engine and mock-tts services in detached mode (needs .env file)"
	@echo "  stop                 - Stop and remove running services defined in docker-compose.yml"
	@echo "  down                 - Alias for stop"
	@echo "  clean                - Run 'stop', remove build artifacts and specific Docker images"
	@echo "  logs                 - Tail logs for running services (needs .env file)"
	@echo "  help                 - Show this help message"
	@echo ""
	@echo "Note: Some targets (external-test, start, stop, logs) might require an '${ENV_FILE}' file in the current directory."