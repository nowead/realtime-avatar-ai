# Makefile for avatar_sync_service

# === Variables ===

# ì•„í‚¤í…ì²˜ ì„¤ì •: ê¸°ë³¸ì€ ì‹œìŠ¤í…œ ê°ì§€, ì‚¬ìš©ì ì§€ì • ê°€ëŠ¥
TARGET_ARCH ?= $(shell uname -m)

ifeq ($(TARGET_ARCH),x86_64)
	TARGET_ARCH := x64
else ifeq ($(TARGET_ARCH),aarch64)
	TARGET_ARCH := arm64
else ifeq ($(TARGET_ARCH),arm64)
	TARGET_ARCH := arm64
else
	$(warning "Unsupported architecture: $(TARGET_ARCH). Falling back to x64.")
	TARGET_ARCH := x64
endif

# Docker ì´ë¯¸ì§€ ë° íŒŒì¼ ì´ë¦„ ì„¤ì •
AVATAR_SYNC_IMAGE_NAME := avatar-sync-service
AVATAR_SYNC_DOCKERFILE := Dockerfile

# Docker Compose íŒŒì¼ (í•„ìš”í•œ ê²½ìš°)
COMPOSE_FILE := docker-compose.yml # avatar_sync_serviceìš© docker-compose.yml í•„ìš”

# .env íŒŒì¼ (í•„ìš”í•œ ê²½ìš°)
ENV_FILE := .env

# === Targets ===

.PHONY: all build build-avatar-sync start stop down clean logs help

all: build
	@echo "âœ… Default target 'all' (build) completed."

# ë©”ì¸ ì„œë¹„ìŠ¤ ì´ë¯¸ì§€ ë¹Œë“œ
build: build-avatar-sync
	@echo "âœ… All required Docker images built successfully."

# avatar_sync_service Docker ì´ë¯¸ì§€ ë¹Œë“œ
build-avatar-sync:
	@echo "ğŸš€ Building Avatar Sync Service image (${AVATAR_SYNC_IMAGE_NAME}) for TARGET_ARCH: ${TARGET_ARCH}..."
	docker build \
		--build-arg TARGET_ARCH=${TARGET_ARCH} \
		-t ${AVATAR_SYNC_IMAGE_NAME} \
		-f ${AVATAR_SYNC_DOCKERFILE} .

# ì„œë¹„ìŠ¤ ì‹œì‘ (detached mode) - docker-compose ì‚¬ìš© (í•„ìš”í•œ ê²½ìš°)
start:
	@echo "ğŸš€ Starting Avatar Sync service (and any dependencies) in detached mode (TARGET_ARCH: ${TARGET_ARCH})..."
	TARGET_ARCH=${TARGET_ARCH} docker compose -f ${COMPOSE_FILE} --env-file ${ENV_FILE} up -d --build avatar-sync-service
	@echo "âœ… Services started. Use 'make logs' or 'make stop'."

# ì„œë¹„ìŠ¤ ì¤‘ì§€ ë° ì»¨í…Œì´ë„ˆ ì œê±° - docker-compose ì‚¬ìš© (í•„ìš”í•œ ê²½ìš°)
down:
	@echo "ğŸ›‘ Stopping and removing services defined in ${COMPOSE_FILE}..."
	TARGET_ARCH=${TARGET_ARCH} docker compose -f ${COMPOSE_FILE} --env-file ${ENV_FILE} down -v --remove-orphans
	@echo "âœ… Services stopped and removed."

stop: down # Alias

# ë¹Œë“œ ì•„í‹°íŒ©íŠ¸ ë° Docker ë¦¬ì†ŒìŠ¤ ì •ë¦¬
clean:
	@echo "ğŸ§¹ Stopping and removing services (if any)..."
	-TARGET_ARCH=${TARGET_ARCH} docker compose -f ${COMPOSE_FILE} --env-file ${ENV_FILE} down -v --remove-orphans
	@echo "ğŸ§¹ Cleaning up local build artifacts (./build)..."
	rm -rf build
	@echo "ğŸ§¹ Removing Docker images (${AVATAR_SYNC_IMAGE_NAME})..."
	-docker rmi ${AVATAR_SYNC_IMAGE_NAME}
	@echo "ğŸ§¹ Pruning unused Docker data (optional, be careful)..."
	-docker system prune -af # ì£¼ì„ ì²˜ë¦¬: ì‚¬ìš© ì‹œ ì£¼ì˜
	@echo "âœ… Cleanup attempt complete."

# ì‹¤í–‰ ì¤‘ì¸ ì„œë¹„ìŠ¤ ë¡œê·¸ í™•ì¸ - docker-compose ì‚¬ìš© (í•„ìš”í•œ ê²½ìš°)
logs:
	@echo "ğŸ“œ Tailing logs for services defined in ${COMPOSE_FILE}..."
	TARGET_ARCH=${TARGET_ARCH} docker compose -f ${COMPOSE_FILE} --env-file ${ENV_FILE} logs -f --tail=100

# ë„ì›€ë§ ë©”ì‹œì§€
help:
	@echo ""
	@echo "Makefile for Avatar Sync Service"
	@echo "--------------------------"
	@echo "Usage: make [target]"
	@echo ""
	@echo "Variables:"
	@echo "  TARGET_ARCH      (Optional) Target architecture (e.g., x64, arm64). Default: auto-detected."
	@echo "                   Example: make TARGET_ARCH=arm64 build"
	@echo "  ENV_FILE         (Optional) Path to .env file. Default: ./.env"
	@echo ""
	@echo "Main Targets:"
	@echo "  all              Build all (currently just the service)."
	@echo "  build            Alias for 'all'."
	@echo "  build-avatar-sync Build the Avatar Sync service Docker image."
	@echo ""
	@echo "Service Management (Docker Compose - if applicable):"
	@echo "  start            Start Avatar Sync service (and dependencies) in detached mode."
	@echo "  stop             Stop and remove running services (alias for 'down')."
	@echo "  down             Stop and remove services, networks, and volumes."
	@echo "  logs             Tail logs from running services."
	@echo ""
	@echo "Cleanup:"
	@echo "  clean            Stop services, remove build artifacts, and Docker images."
	@echo ""
	@echo "Other:"
	@echo "  help             Show this help message."
	@echo ""