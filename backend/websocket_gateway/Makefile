# Makefile for WebSocket Gateway

# === Variables ===

# ì•„í‚¤í…ì²˜ ì„¤ì •: ê¸°ë³¸ì€ ì‹œìŠ¤í…œ ê°ì§€, ì‚¬ìš©ì ì§€ì • ê°€ëŠ¥
TARGET_ARCH ?= $(shell uname -m)

ifeq ($(TARGET_ARCH),x86_64)
	TARGET_ARCH := x64
else ifeq ($(TARGET_ARCH),aarch64)
	TARGET_ARCH := arm64
else ifeq ($(TARGET_ARCH),arm64) # ì¤‘ë³µëœ ì¡°ê±´ì´ì§€ë§Œ, ëª…ì‹œì ìœ¼ë¡œ arm64ë¥¼ ì²˜ë¦¬
	TARGET_ARCH := arm64
else
	$(warning "Unsupported architecture: $(TARGET_ARCH). Falling back to x64.")
	TARGET_ARCH := x64
endif

# Docker ì´ë¯¸ì§€ ë° íŒŒì¼ ì´ë¦„ ì„¤ì •
WEBSOCKET_GATEWAY_IMAGE_NAME := websocket-gateway
WEBSOCKET_GATEWAY_DOCKERFILE := Dockerfile

# ìœ ë‹› í…ŒìŠ¤íŠ¸ ê´€ë ¨ Docker ì´ë¯¸ì§€ ë° íŒŒì¼ ì´ë¦„ ì„¤ì •
UNIT_TEST_IMAGE_NAME := websocket-gateway-unittest
UNIT_TEST_DOCKERFILE := Dockerfile.unit_test

COMPOSE_FILE := docker-compose.yml # docker-compose.yml íŒŒì¼ì´ ìˆë‹¤ê³  ê°€ì •

# === Targets ===

.PHONY: all build build-websocket-gateway build-unit-test test start stop down clean logs help

all: build
	@echo "âœ… Default target 'all' (build) completed."

# ë©”ì¸ ì„œë¹„ìŠ¤ ì´ë¯¸ì§€ ë¹Œë“œ
build: build-websocket-gateway
	@echo "âœ… All required Docker images built successfully."

# WebSocket Gateway Docker ì´ë¯¸ì§€ ë¹Œë“œ
build-websocket-gateway:
	@echo "ğŸš€ Building WebSocket Gateway image (${WEBSOCKET_GATEWAY_IMAGE_NAME}) for TARGET_ARCH: ${TARGET_ARCH}..."
	docker build \
		--build-arg TARGET_ARCH=${TARGET_ARCH} \
		-t ${WEBSOCKET_GATEWAY_IMAGE_NAME} \
		-f ${WEBSOCKET_GATEWAY_DOCKERFILE} .

# ìœ ë‹› í…ŒìŠ¤íŠ¸ Docker ì´ë¯¸ì§€ ë¹Œë“œ
build-unit-test:
	@echo "ğŸ§ª Building Unit Test image (${UNIT_TEST_IMAGE_NAME}) for TARGET_ARCH: ${TARGET_ARCH}..."
	docker build \
		--build-arg TARGET_ARCH=${TARGET_ARCH} \
		-t ${UNIT_TEST_IMAGE_NAME} \
		-f ${UNIT_TEST_DOCKERFILE} .

# ìœ ë‹› í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (ë¹Œë“œëœ ìœ ë‹› í…ŒìŠ¤íŠ¸ ì´ë¯¸ì§€ ì‚¬ìš©)
test: build-unit-test
	@echo "â–¶ï¸ Running Unit Tests from image ${UNIT_TEST_IMAGE_NAME}..."
	docker run --rm ${UNIT_TEST_IMAGE_NAME}
	@echo "âœ… Unit Tests completed."

# ì„œë¹„ìŠ¤ ì‹œì‘ (detached mode) - docker-compose ì‚¬ìš©
start:
	@echo "ğŸš€ Starting WebSocket Gateway service (and any dependencies) in detached mode (TARGET_ARCH: ${TARGET_ARCH})..."
	@if [ ! -f "${COMPOSE_FILE}" ]; then \
		echo "âš ï¸ Docker Compose file '${COMPOSE_FILE}' not found. Cannot start services via docker-compose."; \
		exit 1; \
	fi
	@if [ ! -f "${ENV_FILE}" ]; then \
		echo "âš ï¸ Environment file '${ENV_FILE}' not found. Proceeding without it for docker-compose if possible."; \
	fi
	TARGET_ARCH=${TARGET_ARCH} docker compose -f ${COMPOSE_FILE} $(if [ -f "${ENV_FILE}" ],--env-file ${ENV_FILE}) up -d --build websocket-gateway
	@echo "âœ… Services started. Use 'make logs' or 'make stop'."

# ì„œë¹„ìŠ¤ ì¤‘ì§€ ë° ì»¨í…Œì´ë„ˆ ì œê±°
down:
	@echo "ğŸ›‘ Stopping and removing services defined in ${COMPOSE_FILE}..."
	@if [ ! -f "${COMPOSE_FILE}" ]; then \
		echo "âš ï¸ Docker Compose file '${COMPOSE_FILE}' not found. Cannot stop services via docker-compose."; \
		exit 0; \
	fi
	TARGET_ARCH=${TARGET_ARCH} docker compose -f ${COMPOSE_FILE} $(if [ -f "${ENV_FILE}" ],--env-file ${ENV_FILE}) down -v --remove-orphans
	@echo "âœ… Services stopped and removed."

stop: down # Alias

# ë¹Œë“œ ì•„í‹°íŒ©íŠ¸ ë° Docker ë¦¬ì†ŒìŠ¤ ì •ë¦¬
clean:
	@echo "ğŸ§¹ Stopping and removing services (if any)..."
	-@if [ -f "${COMPOSE_FILE}" ]; then \
		TARGET_ARCH=${TARGET_ARCH} docker compose -f ${COMPOSE_FILE} $(if [ -f "${ENV_FILE}" ],--env-file ${ENV_FILE}) down -v --remove-orphans; \
	fi
	@echo "ğŸ§¹ Cleaning up local build artifacts (./build)..."
	rm -rf build
	@echo "ğŸ§¹ Removing Docker images (${WEBSOCKET_GATEWAY_IMAGE_NAME}, ${UNIT_TEST_IMAGE_NAME})..."
	-docker rmi ${WEBSOCKET_GATEWAY_IMAGE_NAME} ${UNIT_TEST_IMAGE_NAME}
	@echo "ğŸ§¹ Pruning unused Docker data (optional, be careful)..."
	# -docker system prune -af # ì£¼ì„ ì²˜ë¦¬: ì‚¬ìš© ì‹œ ì£¼ì˜. í•„ìš”ì‹œ ì£¼ì„ í•´ì œ.
	@echo "âœ… Cleanup attempt complete."

# ì‹¤í–‰ ì¤‘ì¸ ì„œë¹„ìŠ¤ ë¡œê·¸ í™•ì¸
logs:
	@echo "ğŸ“œ Tailing logs for services defined in ${COMPOSE_FILE}..."
	@if [ ! -f "${COMPOSE_FILE}" ]; then \
		echo "âš ï¸ Docker Compose file '${COMPOSE_FILE}' not found. Cannot tail logs via docker-compose."; \
		exit 1; \
	fi
	TARGET_ARCH=${TARGET_ARCH} docker compose -f ${COMPOSE_FILE} $(if [ -f "${ENV_FILE}" ],--env-file ${ENV_FILE}) logs -f --tail=100 websocket-gateway

# ë„ì›€ë§ ë©”ì‹œì§€
help:
	@echo ""
	@echo "Makefile for WebSocket Gateway"
	@echo "------------------------------"
	@echo "Usage: make [target]"
	@echo ""
	@echo "Variables:"
	@echo "  TARGET_ARCH          (Optional) Target architecture (e.g., x64, arm64). Default: auto-detected."
	@echo "                       Example: make TARGET_ARCH=arm64 build"
	@echo "  ENV_FILE             (Optional) Path to .env file for docker-compose. Default: ./.env"
	@echo "  COMPOSE_FILE         (Optional) Path to docker-compose file. Default: ./docker-compose.yml"
	@echo ""
	@echo "Main Targets:"
	@echo "  all                  Build all (currently just the service image)."
	@echo "  build                Alias for 'all'."
	@echo "  build-websocket-gateway Build the WebSocket Gateway Docker image."
	@echo ""
	@echo "Unit Testing:"
	@echo "  build-unit-test      Build the Docker image for running unit tests."
	@echo "  test                 Build the unit test image (if not already built) and run tests."
	@echo ""
	@echo "Service Management (Docker Compose):"
	@echo "  start                Start WebSocket Gateway service (and dependencies) in detached mode."
	@echo "  stop                 Stop and remove running services (alias for 'down')."
	@echo "  down                 Stop and remove services, networks, and volumes."
	@echo "  logs                 Tail logs from running services (specifically for websocket-gateway)."
	@echo ""
	@echo "Cleanup:"
	@echo "  clean                Stop services, remove build artifacts, and related Docker images."
	@echo ""
	@echo "Other:"
	@echo "  help                 Show this help message."
	@echo ""